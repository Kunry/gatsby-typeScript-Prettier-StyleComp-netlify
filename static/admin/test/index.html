<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>

  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
    <script src="https://sleepy-kepler-5e395e.netlify.com/admin/test2/cms.js"></script>

    <h2>Log in</h2>
    <form name="login">
      <div class="message"></div>
      <p>
        <label>Email<br/><input type="email" name="email" required/></label>
      </p>
      <p>
        <label>Password<br/><input type="password" name="password" required/></label>
      </p>
      <button type="submit">Log in</button>
    </form>
    <!-- <div data-netlify-identity-menu></div> -->

    <!-- Add a simpler button:
      Simple button that will open the modal.
    -->
    <!-- <div data-netlify-identity-button>Login with Netlify Identity</div> -->
  <!-- Include the script that builds the page and powers Netlify CMS -->
  
  <script>

    const auth = new GoTrue({
      APIUrl: "https://sleepy-kepler-5e395e.netlify.com/.netlify/identity",
      audience: "",
      setCookie: false
    });
    const user = auth.login("gabriel.cebrian@ironhack.com", "12345678")
    .then(user => {
      const link = document.createElement('link');
      link.rel = 'import';
      link.href = 'config.yml';
      document.head.appendChild(link);
      link.onload = function(e) {console.log('Loaded import: ' + e.target.href)};
      // importScripts("./config.yml");
      console.log("USER:", user);
      const {
      app_metadata, created_at, confirmed_at, email, id, user_metadata
    } = user;
      localStorage.setItem(
      "gotrue.user",
      JSON.stringify({...user})
    );
      localStorage.setItem(
      "netlify-cms-user",
      JSON.stringify({"backendName":"git-gateway"})
    );
      // document.location.href = "/admin/test2";
    })
    .catch(err => {
      console.log("ERROR: ", err);
    });
    // document.querySelector("form[name='login']").addEventListener("submit", e => {
    // e.preventDefault();
    // const form = e.target;
    // const { email, password } = form.elements;
    // auth
    //   .login(email.value, password.value)
    //   .then(response => {
    //     const myAuthHeader = "Bearer " + response.token.access_token; //creates the bearer token
    //     fetch("/.netlify/functions/update", {
    //       headers: { Authorization: myAuthHeader },
    //       credentials: "include"
    //     })
    //       .then(response => {
    //         console.log({ response });
    //       })
    //       .catch(console.info);
    //   })
      // .catch(console.info);
// });
      // if (window.netlifyIdentity) {
      //   window.netlifyIdentity.on("init", user => {
      //       console.log(user);
      //     if (!user) {
      //       window.netlifyIdentity.on("login", () => {
      //         document.location.href = "/admin/";
      //       });
      //     }
      //   });
      // }
    </script>
</body>
</html>
